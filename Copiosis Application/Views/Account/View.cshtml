@* This is the page for viewing transactions by consumers and producers *@
@* Page for creating transactions for both producers and consumers, do they need to be separate pages? *@
@model Copiosis_Application.Models.TransactionModel

<div class="row">
    <div class="col-lg-10 col-lg-offset-1 col-md-10 col-md-offset-1 col-xs-10 col-xs-offset-1">
        <h2 id="add-item-title">View Transaction</h2>

        @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "ConfirmForm" }))
        {
            @Html.AntiForgeryToken()
            @Html.Partial("ValidationSummary", ViewData.ModelState)

            <p style="color:#33CC33; font-weight:bold" id="updateSuccess" class="hidden">Update Success!</p>

        if (Model.providerID == WebSecurity.CurrentUserId || Model.receiverID == WebSecurity.CurrentUserId)
        {
        <div>
            <div class="row">
                <div class="col-lg-6 col-md-6 col-xs-12">
                    <p>Producer: @Model.providerFirstName @Model.providerLastName</p>
                    <p>Consumer: @Model.receiverFirstName @Model.receiverLastName</p>
                    <p>Product/Service: @Model.productName</p>
                </div>
                <div class="col-lg-6 col-md-6 col-xs-12">
                    <p>Date Created: @Model.dateAdded</p>
                    @if (Model.dateClosed != DateTime.MinValue)
                            {
                        <p>Date Complete: @Model.dateClosed</p>
                            }
                    <p>Product Gateway: @Model.productGateway</p>
                    @if(Model.status.CompareTo("PENDING") !=0)
                            {
                        <p>Transaction Status:
                            @if(Model.status.CompareTo("Rejected") == 0)
                            {
                                <span style="font-weight:bold; color:red">@Model.status</span>
                            }
                            else if (Model.status.CompareTo("Confirmed") == 0)
                            {
                                <span style="font-weight:bold; color:#33CC33">@Model.status</span>
                            }
                            </p>
                            }
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 col-md-12 col-xs-12">
                    @if (Model.providerID == WebSecurity.CurrentUserId && Model.status.CompareTo("PENDING") == 0)
                            {
                        <p>Producer Notes -- <span id="add-provider-notes" class="clickable">Add Notes</span></p>
                            }
                            else if (Model.providerNotes != null)
                            {
                                <p>Producer Notes</p>
                            }
                    @if (Model.status.CompareTo("PENDING") == 0)
                            {
                                if (Model.providerNotes != null)
                                {
                                    <div class="col-lg-12 col-md-12 col-xs-12" style="padding-left:0px">
                                        @if (Model.providerID == WebSecurity.CurrentUserId)
                                        {
                                            @Html.TextAreaFor(t => t.providerNotes, new { @class = "form-control", @placeholder = "Notes", @rows = "4", @cols = "40", @id = "provider-notes", @val = Model.providerNotes })
                                        }
                                        else
                                        {
                                            @Html.TextAreaFor(t => t.providerNotes, new { @class = "form-control", @placeholder = "Notes", @rows = "4", @cols = "40", @id = "provider-notes", @val = Model.providerNotes, @readonly=true})
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="col-lg-12 col-md-12 col-xs-12" style="padding-left:0px">
                                        @if (Model.providerID == WebSecurity.CurrentUserId)
                                        {
                                            @Html.TextAreaFor(t => t.providerNotes, new { @class = "form-control hidden-notes", @placeholder = "Notes", @rows = "4", @cols = "40", @id = "provider-notes", @val = Model.providerNotes })
                                        }
                                    </div>
                                }
                            }
                            else if(Model.providerNotes != null)
                            {
                                @Html.TextAreaFor(t => t.providerNotes, new { @class = "form-control", @rows = "4", @cols = "40", @id = "provider-notes", @val = Model.providerNotes, @readonly = true })
                            }

                    @if (Model.receiverID == WebSecurity.CurrentUserId && Model.status.CompareTo("PENDING")==0)
                            {
                        <p>Consumer Notes -- <span id="add-consumer-notes" class="clickable">Add Notes</span></p>
                            }
                            else if(Model.receiverNotes != null)
                            {
                                <p>Consumer Notes</p>
                            }
                    @if (Model.status.CompareTo("PENDING") == 0)
                            {
                                if (Model.receiverNotes != null)
                                {
                                    <div class="col-lg-12 col-md-12 col-xs-12" style="padding-left:0px">
                                        @if (Model.receiverID == WebSecurity.CurrentUserId)
                                        {
                                            @Html.TextAreaFor(t => t.receiverNotes, new { @class = "form-control", @placeholder = "Notes", @rows = "4", @cols = "80", @id = "receiver-notes", @val = Model.receiverNotes })
                                        }
                                        else
                                        {
                                            @Html.TextAreaFor(t => t.receiverNotes, new { @class = "form-control", @placeholder = "Notes", @rows = "4", @cols = "80", @id = "receiver-notes", @val = Model.receiverNotes, @readonly=true })
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="col-lg-12 col-md-12 col-xs-12" style="padding-left:0px">
                                        @if (Model.receiverID == WebSecurity.CurrentUserId)
                                        {
                                            @Html.TextAreaFor(t => t.receiverNotes, new { @class = "form-control hidden-notes", @placeholder = "Notes", @rows = "4", @cols = "80", @id = "receiver-notes", @val = Model.receiverNotes })
                                        }
                                    </div>
                                }
                            }
                            else if(Model.receiverNotes != null)
                            {
                                @Html.TextAreaFor(t => t.receiverNotes, new { @class = "form-control", @rows = "4", @cols = "80", @id = "receiver-notes", @val = Model.receiverNotes, @readonly=true })
                            }

                    @if (Model.status.CompareTo("PENDING") != 0 && Model.status.CompareTo("Rejected") != 0)
                            {
                        <p>
                            Satisfaction Rating =
                            @if (Model.satisfaction == -2)
                                    {
                                <img src="~/Content/cry.ico" alt="Very Unsatisfied" height="32" width="32" />
                                    }
                            @if (Model.satisfaction == -1)
                                    {
                                <img src="~/Content/sad.ico" alt="Unsatisfied" height="32" width="32" />
                                    }
                            @if (Model.satisfaction == 0)
                                    {
                                <img src="~/Content/smiley_neutral.ico" alt="Neutral" height="32" width="32" />
                                    }
                            @if (Model.satisfaction == 1)
                                    {
                                <img src="~/Content/smile_1.ico" alt="Satisfied" height="32" width="32" />
                                    }
                            @if (Model.satisfaction == 2)
                                    {
                                <img src="~/Content/happy.ico" alt="Very Satisfied" height="32" width="32" />
                                    }
                        </p>
                            }
                            else if(WebSecurity.CurrentUserId == Model.receiverID && Model.status.CompareTo("Rejected") != 0)
                            {
                                <div class="col-lg-3 col-md-3 col-xs-12" style="margin-top:24px; padding-left:0">
                                    <p>Satisfaction Rating:</p>
                                </div>
                                <div class="col-lg-9 col-md-9 col-xs-12" id="satisfaction-rating-radios">
                                    @if (Model.satisfaction == -2)
                                    {
                                        @Html.RadioButtonFor(m => m.satisfaction, -2, new { @name = "SR", @id = "very-unsatisfied" })
                                        <label for="very-unsatisfied" id="veryUnsatisfiedLabel" class="selected"><img src="~/Content/cry.ico" alt="Very Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, -1, new { @name = "SR", @id = "unsatisfied" })
                                        <label for="unsatisfied" id="unsatisfiedLabel"><img src="~/Content/sad.ico" alt="Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 0, new { @name = "SR", @id = "neutral" })
                                        <label for="neutral" id="neutralLabel"><img src="~/Content/smiley_neutral.ico" alt="neutral" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 1, new { @name = "SR", @id = "satisfied" })
                                        <label for="satisfied" id="satisfiedLabel"><img src="~/Content/smile_1.ico" alt="satisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 2, new { @name = "SR", @id = "very-satisfied" })
                                        <label for="very-satisfied" id="verySatisfiedLabel"><img src="~/Content/happy.ico" alt="Very Satisfied" height="32" width="32" /></label>
                                    }
                                    @if (Model.satisfaction == -1)
                                    {
                                        @Html.RadioButtonFor(m => m.satisfaction, -2, new { @name = "SR", @id = "very-unsatisfied" })
                                        <label for="very-unsatisfied" id="veryUnsatisfiedLabel"><img src="~/Content/cry.ico" alt="Very Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, -1, new { @name = "SR", @id = "unsatisfied" })
                                        <label for="unsatisfied" class="selected" id="unsatisfiedLabel"><img src="~/Content/sad.ico" alt="Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 0, new { @name = "SR", @id = "neutral" })
                                        <label for="neutral" id="neutralLabel"><img src="~/Content/smiley_neutral.ico" alt="neutral" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 1, new { @name = "SR", @id = "satisfied" })
                                        <label for="satisfied" id="satisfiedLabel"><img src="~/Content/smile_1.ico" alt="satisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 2, new { @name = "SR", @id = "very-satisfied" })
                                        <label for="very-satisfied" id="verySatisfiedLabel"><img src="~/Content/happy.ico" alt="Very Satisfied" height="32" width="32" /></label>
                                    }
                                    @if (Model.satisfaction == 0)
                                    {
                                        @Html.RadioButtonFor(m => m.satisfaction, -2, new { @name = "SR", @id = "very-unsatisfied" })
                                        <label for="very-unsatisfied" id="veryUnsatisfiedLabel"><img src="~/Content/cry.ico" alt="Very Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, -1, new { @name = "SR", @id = "unsatisfied" })
                                        <label for="unsatisfied" id="unsatisfiedLabel"><img src="~/Content/sad.ico" alt="Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 0, new { @name = "SR", @id = "neutral" })
                                        <label for="neutral" id="neutralLabel" class="selected"><img src="~/Content/smiley_neutral.ico" alt="neutral" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 1, new { @name = "SR", @id = "satisfied" })
                                        <label for="satisfied" id="satisfiedLabel"><img src="~/Content/smile_1.ico" alt="satisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 2, new { @name = "SR", @id = "very-satisfied" })
                                        <label for="very-satisfied" id="verySatisfiedLabel"><img src="~/Content/happy.ico" alt="Very Satisfied" height="32" width="32" /></label>
                                    }
                                    @if (Model.satisfaction == 1)
                                    {
                                        @Html.RadioButtonFor(m => m.satisfaction, -2, new { @name = "SR", @id = "very-unsatisfied" })
                                        <label for="very-unsatisfied" id="veryUnsatisfiedLabel"><img src="~/Content/cry.ico" alt="Very Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, -1, new { @name = "SR", @id = "unsatisfied" })
                                        <label for="unsatisfied" id="unsatisfiedLabel"><img src="~/Content/sad.ico" alt="Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 0, new { @name = "SR", @id = "neutral" })
                                        <label for="neutral" id="neutralLabel"><img src="~/Content/smiley_neutral.ico" alt="neutral" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 1, new { @name = "SR", @id = "satisfied" })
                                        <label for="satisfied" class="selected" id="satisfiedLabel"><img src="~/Content/smile_1.ico" alt="satisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 2, new { @name = "SR", @id = "very-satisfied" })
                                        <label for="very-satisfied" id="verySatisfiedLabel"><img src="~/Content/happy.ico" alt="Very Satisfied" height="32" width="32" /></label>
                                    }
                                    @if (Model.satisfaction == 2)
                                    {
                                        @Html.RadioButtonFor(m => m.satisfaction, -2, new { @name = "SR", @id = "very-unsatisfied" })
                                        <label for="very-unsatisfied" id="veryUnsatisfiedLabel"><img src="~/Content/cry.ico" alt="Very Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, -1, new { @name = "SR", @id = "unsatisfied" })
                                        <label for="unsatisfied" id="unsatisfiedLabel"><img src="~/Content/sad.ico" alt="Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 0, new { @name = "SR", @id = "neutral" })
                                        <label for="neutral" id="neutralLabel"><img src="~/Content/smiley_neutral.ico" alt="neutral" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 1, new { @name = "SR", @id = "satisfied" })
                                        <label for="satisfied" id="satisfiedLabel"><img src="~/Content/smile_1.ico" alt="satisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 2, new { @name = "SR", @id = "very-satisfied" })
                                        <label for="very-satisfied" class="selected" id="verySatisfiedLabel"><img src="~/Content/happy.ico" alt="Very Satisfied" height="32" width="32" /></label>
                                    }

                                    @if (Model.satisfaction == null)
                                    {
                                        @Html.RadioButtonFor(m => m.satisfaction, -2, new { @name = "SR", @id = "very-unsatisfied" })
                                        <label for="very-unsatisfied" id="veryUnsatisfiedLabel"><img src="~/Content/cry.ico" alt="Very Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, -1, new { @name = "SR", @id = "unsatisfied" })
                                        <label for="unsatisfied" id="unsatisfiedLabel"><img src="~/Content/sad.ico" alt="Unsatisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 0, new { @name = "SR", @id = "neutral" })
                                        <label for="neutral" id="neutralLabel"><img src="~/Content/smiley_neutral.ico" alt="neutral" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 1, new { @name = "SR", @id = "satisfied" })
                                        <label for="satisfied" id="satisfiedLabel"><img src="~/Content/smile_1.ico" alt="satisfied" height="32" width="32" /></label>
                                        @Html.RadioButtonFor(m => m.satisfaction, 2, new { @name = "SR", @id = "very-satisfied" })
                                        <label for="very-satisfied" id="verySatisfiedLabel"><img src="~/Content/happy.ico" alt="Very Satisfied" height="32" width="32" /></label>
                                    }
                                </div>
                            }
                            else if(WebSecurity.CurrentUserId == Model.providerID && Model.status.CompareTo("Rejected") != 0)
                            {
                                <p>Satisfaction Rating: <span style="font-weight:bold">Pending Transaction Confirmation or Rejection</span></p>
                            }

                    @if (Model.isPendingUser == true && Model.dateClosed == DateTime.MinValue)
                            {
                        <div>
                            @Html.TextBoxFor(m => m.transactionID, new { @class = "hidden", @val = Model.transactionID })
                            @Html.TextBoxFor(m => m.result, new { @class = "hidden" })
                            <input id="confirm" type="button" value="Confirm Transaction Details" />
                            <input id="reject" type="button" value="Reject Transaction" />
                        </div>
                            }
                            else if(Model.isPendingUser == false && Model.dateClosed == DateTime.MinValue)
                            {
                                <div>
                                    <input id="updateResult" class="hidden" type="text" value="null" />
                                    @Html.TextBoxFor(m => m.transactionID, new { @class = "hidden", @val = Model.transactionID })
                                    @Html.TextBoxFor(m => m.result, new { @class = "hidden" })
                                    <input id="update" type="button" value="Update Transaction Details" />
                                </div>
                            }
                </div>
            </div>
        </div>
        }
        }
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        //Function for updating
        $("#update").click(function (e) {
            var userType;
            //Check to see what type of user is logged in and update userType
            @if(WebSecurity.CurrentUserId == Model.receiverID)
            {
                <text>userType = 'consumer';</text>
            }
            else
            {
                <text>userType = 'producer';</text>
            }
                    
            var userNotes;
            //Grab our transactionID from the model
            var transGuid = '@Model.transactionID';
            //Determine updated satisfaction rating if any
            var selectedSatisfaction = $('#updateResult').val();
            //Grab the correct notes
            if(userType === "consumer")
                userNotes = $('#receiver-notes').val();
            else
                userNotes = $('#provider-notes').val();
            $.ajax({
                url: "/Account/AddNotes/",
                type: "post",
                //Send the controller the information it needs
                data: { participant: userType, notes: userNotes, tranId: transGuid, newSatisfaction: selectedSatisfaction},
                success: function (result) {
                    $("#updateSuccess").removeClass('hidden')
                },
                error: function (result) {
                    console.log("Error updating transaction: " + transGuid);
                }
            });
        })
        @*This is to handle the satisfaction rating*@
        $('#satisfaction-rating-radios input:radio').addClass('input_hidden');
        $('#satisfaction-rating-radios label').click(function () {
            $(this).addClass('selected').siblings().removeClass('selected');
        });

        $('#veryUnsatisfiedLabel').click(function () {
            $('#updateResult').val("-2");
        })
        $('#unsatisfiedLabel').click(function () {
            $('#updateResult').val("-1");
        })
        $('#neutralLabel').click(function () {
            $('#updateResult').val("0");
        })
        $('#satisfiedLabel').click(function () {
            $('#updateResult').val("1");
        })
        $('#verySatisfiedLabel').click(function () {
            $('#updateResult').val("2");
        })

        $("#reject").click(function (e) {
            $("#result").val("Rejected");
            $("#very-unsatisfied").attr('checked', true);
            $("#ConfirmForm").submit();
        })

        $("#confirm").click(function (e) {
            $("#result").val("Confirmed");
            $("#ConfirmForm").submit();
        })

        $('#add-consumer-notes').click(function(){
            $('#receiver-notes').toggleClass('hidden-notes');
        })

        $('#add-provider-notes').click(function(){
            $('#provider-notes').toggleClass('hidden-notes');
        })
    </script>

    @Scripts.Render("~/bundles/jqueryval")
}